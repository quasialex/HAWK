<a class="back" href="/">← Home</a>
<h2>Interactive Terminal</h2>

<% if @session %>
  <div class="controls" style="display:flex; gap:10px; margin:10px 0;">
    <form method="post" action="/tty/<%= @session %>/stop" onsubmit="return confirm('Stop this terminal?');">
      <button class="danger" type="submit">Stop</button>
    </form>
    <button class="pill" onclick="sendKey('CTRL_C')">Ctrl‑C</button>
    <button class="pill" onclick="sendKey('ENTER')">Enter</button>
    <button class="pill" onclick="sendKey('TAB')">Tab</button>
  </div>

  <pre id="tty" class="log" style="height:58vh; overflow:auto; white-space:pre-wrap; background:#111; color:#ddd; padding:10px; border-radius:8px;"></pre>

  <div style="display:flex; gap:8px; margin-top:8px;">
    <input id="cmd" type="text" placeholder="type a command…" style="flex:1; padding:8px; border-radius:6px; border:1px solid #444; background:#181818; color:#eee">
    <button class="pill" onclick="sendText()">Send</button>
  </div>

  <script>
    const session = "<%= @session %>";
    const logEl = document.getElementById('tty');
    const cmdEl = document.getElementById('cmd');

    async function refresh() {
      try {
        const r = await fetch(`/tty/${session}/poll?lines=2000`, {cache:'no-store'});
        if (!r.ok) return;
        const data = await r.json();
        logEl.textContent = data.text || '';
        logEl.scrollTop = logEl.scrollHeight;
      } catch(e) {
        console.error(e);
      }
    }
    setInterval(refresh, 1000);
    refresh();

    async function sendText() {
      const text = cmdEl.value;
      cmdEl.value = '';
      await fetch(`/tty/${session}/send`, {method:'POST', headers:{'Content-Type':'application/x-www-form-urlencoded'}, body: new URLSearchParams({text, enter:'1'})});
      setTimeout(refresh, 150);
    }
    async function sendKey(key) {
      await fetch(`/tty/${session}/send`, {method:'POST', headers:{'Content-Type':'application/x-www-form-urlencoded'}, body: new URLSearchParams({key})});
      setTimeout(refresh, 150);
    }
    cmdEl.addEventListener('keydown', e => {
      if (e.key === 'Enter') { e.preventDefault(); sendText(); }
      if (e.key === 'Tab')   { e.preventDefault(); sendKey('TAB'); }
      if (e.key === 'c' && e.ctrlKey) { e.preventDefault(); sendKey('CTRL_C'); }
    });
  </script>

<% else %>
  <form method="post" action="/tty/new">
    <button type="submit" class="pill">New Shell</button>
  </form>

  <h3>Existing tmux sessions</h3>
  <ul class="sessions">
    <% @sessions.each do |s| %>
      <li>
        <code><%= s %></code>
        <a class="pill" href="/tty/<%= s %>">Open</a>
      </li>
    <% end %>
  </ul>
<% end %>
